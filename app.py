# app.py

import streamlit as st
import os
import requests
import groq
import wikipedia
import string
import re # Using regular expressions for a smarter parser
from urllib.parse import quote_plus
from dotenv import load_dotenv
from datetime import datetime

# --- INITIAL SETUP AND CONFIGURATION ---

load_dotenv()

# Configure Groq API
try:
    groq_client = groq.Groq(api_key=os.getenv("GROQ_API_KEY"))
    if not os.getenv("GROQ_API_KEY"):
        st.error("Groq API key not found. Please check your .env file.", icon="ЁЯЪи")
        st.stop()
except Exception as e:
    st.error(f"Error configuring the Groq API. Details: {e}", icon="ЁЯЪи")
    st.stop()

# Get the Weather API key
WEATHER_API_KEY = os.getenv("WEATHER_API_KEY")

# --- TRANSLATIONS DICTIONARY ---
translations = {
    "en": {
        "title": "Trip Whisperer: Your AI Travel Companion тЬИя╕П",
        "placeholder": "e.g., Paris, Tokyo, New York",
        "button": "Generate Guide",
        "spinner": "Conjuring a travel guide for {city_name}... тЬи",
        "weather_header": "Current Weather in {city_name}:",
        "flights_button": "Search for Flights to {city_name}",
        "summary_header": "A Glimpse into {city_name}",
        "summary_error": "Could not find a Wikipedia summary for '{city_name}' (language: {lang_code}).",
        "guide_error": "Could not generate guide. AI model error: {e}",
        "success": "Your personalized travel guide is ready! Click any item to explore it on Google Maps.",
        "lang_name": "English",
        "lang_select": "Select Language",
        "footer": "Created by Sheikh Imran ┬й 2025. All rights reserved.",
        "download_button": "Download Guide as .txt"
    },
    "es": {
        "title": "Susurrador de Viajes: Tu Compa├▒ero de IA тЬИя╕П",
        "placeholder": "ej., Par├нs, Tokio, Nueva York",
        "button": "Generar Gu├нa",
        "spinner": "Conjurando una gu├нa de viaje para {city_name}... тЬи",
        "weather_header": "Tiempo actual en {city_name}:",
        "flights_button": "Buscar Vuelos a {city_name}",
        "summary_header": "Un Vistazo a {city_name}",
        "summary_error": "No se pudo encontrar un resumen de Wikipedia para '{city_name}' (idioma: {lang_code}).",
        "guide_error": "No se pudo generar la gu├нa. Error del modelo de IA: {e}",
        "success": "┬бTu gu├нa de viaje personalizada est├б lista! Haz clic en cualquier elemento para explorarlo en Google Maps.",
        "lang_name": "Espa├▒ol",
        "lang_select": "Seleccionar Idioma",
        "footer": "Creado por Sheikh Imran ┬й 2025. Todos los derechos reservados.",
        "download_button": "Descargar Gu├нa como .txt"
    },
    "hi": {
        "title": "рдЯреНрд░рд┐рдк рд╡реНрд╣рд┐рд╕реНрдкрд░рд░: рдЖрдкрдХрд╛ AI рдпрд╛рддреНрд░рд╛ рд╕рд╛рдереА тЬИя╕П",
        "placeholder": "рдЬреИрд╕реЗ, рдкреЗрд░рд┐рд╕, рдЯреЛрдХреНрдпреЛ, рдиреНрдпреВрдпреЙрд░реНрдХ",
        "button": "рдЧрд╛рдЗрдб рддреИрдпрд╛рд░ рдХрд░реЗрдВ",
        "spinner": "{city_name} рдХреЗ рд▓рд┐рдП рдПрдХ рдпрд╛рддреНрд░рд╛ рдЧрд╛рдЗрдб рддреИрдпрд╛рд░ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ... тЬи",
        "weather_header": "{city_name} рдореЗрдВ рд╡рд░реНрддрдорд╛рди рдореМрд╕рдо:",
        "flights_button": "{city_name} рдХреЗ рд▓рд┐рдП рдЙрдбрд╝рд╛рдиреЗрдВ рдЦреЛрдЬреЗрдВ",
        "summary_header": "{city_name} рдХреА рдПрдХ рдЭрд▓рдХ",
        "summary_error": "'{city_name}' рдХреЗ рд▓рд┐рдП рд╡рд┐рдХрд┐рдкреАрдбрд┐рдпрд╛ рд╕рд╛рд░рд╛рдВрд╢ рдирд╣реАрдВ рдорд┐рд▓ рд╕рдХрд╛ (рднрд╛рд╖рд╛: {lang_code}).",
        "guide_error": "рдЧрд╛рдЗрдб рдЙрддреНрдкрдиреНрди рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛ред AI рдореЙрдбрд▓ рддреНрд░реБрдЯрд┐: {e}",
        "success": "рдЖрдкрдХреА рд╡реНрдпрдХреНрддрд┐рдЧрдд рдпрд╛рддреНрд░рд╛ рдЧрд╛рдЗрдб рддреИрдпрд╛рд░ рд╣реИ! Google рдорд╛рдирдЪрд┐рддреНрд░ рдкрд░ рдЗрд╕рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рд╕реА рднреА рдЖрдЗрдЯрдо рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред",
        "lang_name": "рд╣рд┐рдВрджреА",
        "lang_select": "рднрд╛рд╖рд╛ рдЪреБрдиреЗрдВ",
        "footer": "рд╢реЗрдЦ рдЗрдорд░рд╛рди рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдорд┐рдд ┬й 2025. рд╕рд░реНрд╡рд╛рдзрд┐рдХрд╛рд░ рд╕реБрд░рдХреНрд╖рд┐рддред",
        "download_button": "рдЧрд╛рдЗрдб рдХреЛ .txt рдХреЗ рд░реВрдк рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ"
    },
    "fr": {
        "title": "Murmure de Voyage : Votre Compagnon IA тЬИя╕П",
        "placeholder": "ex: Paris, Tokyo, New York",
        "button": "G├йn├йrer le Guide",
        "spinner": "Pr├йparation d'un guide de voyage pour {city_name}... тЬи",
        "weather_header": "M├йt├йo actuelle ├а {city_name} :",
        "flights_button": "Rechercher des vols vers {city_name}",
        "summary_header": "Un aper├зu de {city_name}",
        "summary_error": "Impossible de trouver un r├йsum├й Wikipedia pour '{city_name}' (langue : {lang_code}).",
        "guide_error": "Impossible de g├йn├йrer le guide. Erreur du mod├иle IA : {e}",
        "success": "Votre guide de voyage personnalis├й est pr├кt ! Cliquez sur un ├йl├йment pour l'explorer sur Google Maps.",
        "lang_name": "Fran├зais",
        "lang_select": "Choisir la langue",
        "footer": "Cr├й├й par Sheikh Imran ┬й 2025. Tous droits r├йserv├йs.",
        "download_button": "T├йl├йcharger le guide en .txt"
    },
    "te": {
        "title": "р░Яр▒Нр░░р░┐р░кр▒Н р░╡р░┐р░╕р▒Нр░кр░░р░░р▒Н: р░ор▒А AI р░кр▒Нр░░р░пр░╛р░г р░╕р░╣р░Ър░░р▒Бр░бр▒Б тЬИя╕П",
        "placeholder": "р░Йр░жр░╛., р░кр░╛р░░р░┐р░╕р▒Н, р░Яр▒Лр░Хр▒Нр░пр▒Л, р░ир▒Нр░пр▒Вр░пр░╛р░░р▒Нр░Хр▒Н",
        "button": "р░Чр▒Ир░бр▒Н р░░р▒Вр░кр▒Кр░Вр░жр░┐р░Вр░Ър▒Б",
        "spinner": "{city_name} р░Хр▒Лр░╕р░В р░кр▒Нр░░р░пр░╛р░г р░Чр▒Ир░бр▒НтАМр░ир▒Б р░╕р░┐р░жр▒Нр░зр░В р░Ър▒Зр░╕р▒Нр░др▒Лр░Вр░жр░┐... тЬи",
        "weather_header": "{city_name}р░▓р▒Л р░кр▒Нр░░р░╕р▒Нр░др▒Бр░д р░╡р░╛р░др░╛р░╡р░░р░гр░В:",
        "flights_button": "{city_name} р░Хр▒Лр░╕р░В р░╡р░┐р░ор░╛р░ир░╛р░▓р░ир▒Б р░╢р▒Лр░зр░┐р░Вр░Ър░Вр░бр░┐",
        "summary_header": "{city_name} р░пр▒Кр░Хр▒Нр░Х р░╕р░Вр░Чр▒Нр░░р░╣р░╛р░╡р░▓р▒Лр░Хр░ир░В",
        "summary_error": "'{city_name}' р░Хр▒Лр░╕р░В р░╡р░┐р░Хр▒Ар░кр▒Ар░бр░┐р░пр░╛ р░╕р░╛р░░р░╛р░Вр░╢р░В р░Хр░ир▒Бр░Чр▒Кр░ир░мр░бр░▓р▒Зр░жр▒Б (р░нр░╛р░╖: {lang_code}).",
        "guide_error": "р░Чр▒Ир░бр▒Н р░░р▒Вр░кр▒Кр░Вр░жр░┐р░Вр░Ър░мр░бр░▓р▒Зр░жр▒Б. AI р░ор▒Лр░бр░▓р▒Н р░▓р▒Лр░кр░В: {e}",
        "success": "р░ор▒А р░╡р▒Нр░пр░Хр▒Нр░др░┐р░Чр░д р░кр▒Нр░░р░пр░╛р░г р░Чр▒Ир░бр▒Н р░╕р░┐р░жр▒Нр░зр░Вр░Чр░╛ р░Йр░Вр░жр░┐! Google р░ор▒Нр░пр░╛р░кр▒Нр░╕р▒НтАМр░▓р▒Л р░Ер░ир▒Нр░╡р▒Зр░╖р░┐р░Вр░Ър░бр░╛р░ир░┐р░Хр░┐ р░Пр░жр▒Ир░ир░╛ р░Рр░Яр▒Жр░ор▒НтАМр░кр▒И р░Хр▒Нр░▓р░┐р░Хр▒Н р░Ър▒Зр░пр░Вр░бр░┐.",
        "lang_name": "р░др▒Жр░▓р▒Бр░Чр▒Б",
        "lang_select": "р░нр░╛р░╖р░ир▒Б р░Ор░Вр░Ър▒Бр░Хр▒Лр░Вр░бр░┐",
        "footer": "р░╖р▒Зр░Хр▒Н р░Зр░ор▒Нр░░р░╛р░ир▒Н р░жр▒Нр░╡р░╛р░░р░╛ р░╕р▒Гр░╖р▒Нр░Яр░┐р░Вр░Ър░мр░бр░┐р░Вр░жр░┐ ┬й 2025. р░Ер░ир▒Нр░ир░┐ р░╣р░Хр▒Нр░Хр▒Бр░▓р▒Б р░кр▒Нр░░р░др▒Нр░пр▒Зр░Хр░┐р░Вр░Ър░мр░бр▒Нр░бр░╛р░пр░┐.",
        "download_button": "р░Чр▒Ир░бр▒НтАМр░ир▒Б .txtр░Чр░╛ р░бр▒Мр░ир▒НтАМр░▓р▒Лр░бр▒Н р░Ър▒Зр░пр░Вр░бр░┐"
    },
    "kn": {
        "title": "р▓Яр│Нр▓░р▓┐р▓кр│Н р▓╡р▓┐р▓╕р│Нр▓кр▓░р▓░р│Н: р▓ир▓┐р▓ор│Нр▓о AI р▓кр│Нр▓░р▓╡р▓╛р▓╕ р▓╕р▓Вр▓Чр▓╛р▓др▓┐ тЬИя╕П",
        "placeholder": "р▓Йр▓жр▓╛., р▓кр│Нр▓пр▓╛р▓░р▓┐р▓╕р│Н, р▓Яр│Лр▓Хр▓┐р▓пр│Л, р▓ир│Нр▓пр│Вр▓пр▓╛р▓░р│Нр▓Хр│Н",
        "button": "р▓ор▓╛р▓░р│Нр▓Чр▓жр▓░р│Нр▓╢р▓┐ р▓░р▓Ър▓┐р▓╕р▓┐",
        "spinner": "{city_name} р▓Чр▓╛р▓Чр▓┐ р▓кр│Нр▓░р▓╡р▓╛р▓╕ р▓ор▓╛р▓░р│Нр▓Чр▓жр▓░р│Нр▓╢р▓┐р▓пр▓ир│Нр▓ир│Б р▓░р▓Ър▓┐р▓╕р▓▓р▓╛р▓Чр│Бр▓др│Нр▓др▓┐р▓жр│Ж... тЬи",
        "weather_header": "{city_name} р▓ир▓▓р│Нр▓▓р▓┐ р▓кр│Нр▓░р▓╕р│Нр▓др│Бр▓д р▓╣р▓╡р▓╛р▓ор▓╛р▓и:",
        "flights_button": "{city_name} р▓Чр▓╛р▓Чр▓┐ р▓╡р▓┐р▓ор▓╛р▓ир▓Чр▓│р▓ир│Нр▓ир│Б р▓╣р│Бр▓бр│Бр▓Хр▓┐",
        "summary_header": "{city_name} р▓ж р▓Тр▓Вр▓жр│Б р▓ир│Лр▓Я",
        "summary_error": "'{city_name}' р▓Чр▓╛р▓Чр▓┐ р▓╡р▓┐р▓Хр▓┐р▓кр│Ар▓бр▓┐р▓пр▓╛ р▓╕р▓╛р▓░р▓╛р▓Вр▓╢ р▓Хр▓Вр▓бр│Бр▓мр▓Вр▓жр▓┐р▓▓р│Нр▓▓ (р▓нр▓╛р▓╖р│Ж: {lang_code}).",
        "guide_error": "р▓ор▓╛р▓░р│Нр▓Чр▓жр▓░р│Нр▓╢р▓┐ р▓░р▓Ър▓┐р▓╕р▓▓р│Б р▓╕р▓╛р▓зр│Нр▓пр▓╡р▓╛р▓Чр▓▓р▓┐р▓▓р│Нр▓▓. AI р▓ор▓╛р▓жр▓░р▓┐ р▓жр│Лр▓╖: {e}",
        "success": "р▓ир▓┐р▓ор│Нр▓о р▓╡р│Ир▓пр▓Хр│Нр▓др▓┐р▓Х р▓кр│Нр▓░р▓╡р▓╛р▓╕ р▓ор▓╛р▓░р│Нр▓Чр▓жр▓░р│Нр▓╢р▓┐ р▓╕р▓┐р▓жр│Нр▓зр▓╡р▓╛р▓Чр▓┐р▓жр│Ж! Google р▓ир▓Хр│Нр▓╖р│Жр▓Чр▓│р▓▓р│Нр▓▓р▓┐ р▓Ер▓ир│Нр▓╡р│Зр▓╖р▓┐р▓╕р▓▓р│Б р▓пр▓╛р▓╡р│Бр▓жр│З р▓Рр▓Яр▓В р▓ор│Зр▓▓р│Ж р▓Хр│Нр▓▓р▓┐р▓Хр│Н р▓ор▓╛р▓бр▓┐.",
        "lang_name": "р▓Хр▓ир│Нр▓ир▓б",
        "lang_select": "р▓нр▓╛р▓╖р│Жр▓пр▓ир│Нр▓ир│Б р▓Жр▓пр│Нр▓Хр│Жр▓ор▓╛р▓бр▓┐",
        "footer": "р▓╢р│Зр▓Хр│Н р▓Зр▓ор│Нр▓░р▓╛р▓ир│Н р▓Ер▓╡р▓░р▓┐р▓Вр▓ж р▓░р▓Ър▓┐р▓╕р▓▓р▓╛р▓Чр▓┐р▓жр│Ж ┬й 2025. р▓Ор▓▓р│Нр▓▓р▓╛ р▓╣р▓Хр│Нр▓Хр│Бр▓Чр▓│р▓ир│Нр▓ир│Б р▓Хр▓╛р▓пр│Нр▓жр▓┐р▓░р▓┐р▓╕р▓▓р▓╛р▓Чр▓┐р▓жр│Ж.",
        "download_button": "р▓ор▓╛р▓░р│Нр▓Чр▓жр▓░р│Нр▓╢р▓┐р▓пр▓ир│Нр▓ир│Б .txt р▓Жр▓Чр▓┐ р▓бр│Мр▓ир│НтАМр▓▓р│Лр▓бр│Н р▓ор▓╛р▓бр▓┐"
    },
    "ur": {
        "title": "┘╣╪▒┘╛ ┘И┘Р╪│┘╛╪▒╪▒: ╪в┘╛ ┌й╪з AI ╪│┘Б╪▒█М ╪│╪з╪к┌╛█М тЬИя╕П",
        "placeholder": "┘Е╪л┘Д╪з┘Л╪М ┘╛█М╪▒╪│╪М ┘╣┘И┌й█М┘И╪М ┘Ж█М┘И█М╪з╪▒┌й",
        "button": "┌п╪з╪ж█М┌И ╪и┘Ж╪з╪ж█М┌║",
        "spinner": "{city_name} ┌й█Т ┘Д█М█Т ┘╣╪▒█М┘И┘Д ┌п╪з╪ж█М┌И ╪к█М╪з╪▒ ┌й█М ╪м╪з ╪▒█Б█М █Б█Т... тЬи",
        "weather_header": "{city_name} ┘Е█М┌║ ┘Е┘И╪м┘И╪п█Б ┘Е┘И╪│┘Е:",
        "flights_button": "{city_name} ┌й█Т ┘Д█М█Т ┘╛╪▒┘И╪з╪▓█М┌║ ╪к┘Д╪з╪┤ ┌й╪▒█М┌║",
        "summary_header": "{city_name} ┌й█М ╪з█М┌й ╪м┌╛┘Д┌й",
        "summary_error": "'{city_name}' ┌й█Т ┘Д█М█Т ┘И█М┌й█М┘╛█М┌И█М╪з ┌й╪з ╪о┘Д╪з╪╡█Б ┘Ж█Б█М┌║ ┘Е┘Д ╪│┌й╪з (╪▓╪и╪з┘Ж: {lang_code})█Ф",
        "guide_error": "┌п╪з╪ж█М┌И ╪к█М╪з╪▒ ┘Ж█Б█М┌║ █Б┘И ╪│┌й╪з█Ф AI ┘Е╪з┌И┘Д ┌й█М ╪о╪▒╪з╪и█М: {e}",
        "success": "╪в┘╛ ┌й╪з ╪░╪з╪к█М ┘╣╪▒█М┘И┘Д ┌п╪з╪ж█М┌И ╪к█М╪з╪▒ █Б█Т! Google Maps ┘╛╪▒ ╪з╪│█Т ╪п╪▒█М╪з┘Б╪к ┌й╪▒┘Ж█Т ┌й█Т ┘Д█М█Т ┌й╪│█М ╪и┌╛█М ╪в╪ж┘╣┘Е ┘╛╪▒ ┌й┘Д┌й ┌й╪▒█М┌║█Ф",
        "lang_name": "╪з╪▒╪п┘И",
        "lang_select": "╪▓╪и╪з┘Ж ┘Е┘Ж╪к╪о╪и ┌й╪▒█М┌║█Ф",
        "footer": "╪┤█М╪о ╪╣┘Е╪▒╪з┘Ж ┌й╪з ╪и┘Ж╪з█М╪з █Б┘И╪з ┬й 2025█Ф ╪м┘Е┘Д█Б ╪н┘В┘И┘В ┘Е╪н┘Б┘И╪╕ █Б█М┌║█Ф",
        "download_button": "┌п╪з╪ж█М┌И ┌й┘И .txt ┌й█Т ╪и╪╖┘И╪▒ ┌И╪з╪д┘Ж ┘Д┘И┌И ┌й╪▒█М┌║█Ф"
    }
}


# --- HELPER FUNCTIONS ---

# NEW: Added the Wikipedia image function back
def get_image_url(search_term, lang_code="en"):
    """
    Fetches the main image URL from a Wikipedia page.
    This will find landmarks, but likely not food items.
    """
    placeholder_url = "https://placehold.co/600x400/161B22/58A6FF?text=Image+Not+Found"
    try:
        wikipedia.set_lang(lang_code)
        # Use auto_suggest to find the best match (e.g., "Taj Mahal" from "taj mahal")
        page = wikipedia.page(search_term, auto_suggest=True)
        wikipedia.set_lang("en") # Reset language
        
        # Return the first image, or the placeholder if none found
        return page.images[0] if page.images else placeholder_url
            
    except Exception as e:
        print(f"Error getting Wikipedia image for '{search_term}': {e}") 
        wikipedia.set_lang("en") # Reset language on error
        return placeholder_url

def get_weather_info(city_name, api_key):
    """Fetches real-time weather data from OpenWeatherMap API."""
    if not api_key:
        return "Weather API key not configured."
    
    base_url = "https://api.openweathermap.org/data/2.5/weather"
    params = {
        "q": city_name,
        "appid": api_key,
        "units": "metric"
    }
    try:
        response = requests.get(base_url, params=params)
        response.raise_for_status()
        data = response.json()
        
        weather_desc = data['weather'][0]['description'].title()
        temp = data['main']['temp']
        feels_like = data['main']['feels_like']
        humidity = data['main']['humidity']
        
        return f"**Weather:** {weather_desc} | **Temp:** {temp}┬░C | **Feels Like:** {feels_like}┬░C | **Humidity:** {humidity}%"
    except requests.exceptions.HTTPError:
        return f"Could not find weather for '{city_name}'. Please check the city name."
    except Exception as e:
        return f"Could not retrieve weather data. Error: {e}"

def generate_flight_search_link(city_name):
    """Generates a pre-filled Google Flights search link."""
    query = f"flights to {city_name}"
    encoded_query = quote_plus(query)
    return f"https://www.google.com/search?q={encoded_query}"

def get_city_summary(city_name, lang_code, text_dict):
    """Fetches a concise summary of a city from Wikipedia in the specified language."""
    try:
        wikipedia.set_lang(lang_code) 
        summary = wikipedia.summary(city_name, sentences=3, auto_suggest=True)
        wikipedia.set_lang("en") # Reset to English for safety
        return summary
    except Exception:
        wikipedia.set_lang("en") 
        return text_dict["summary_error"].format(city_name=city_name, lang_code=lang_code)

def generate_travel_guide(city_name, lang_code, text_dict):
    """Uses Groq to generate a structured travel guide in the specified language."""
    
    lang_name = "English" 
    for code, texts in translations.items():
        if code == lang_code:
            lang_name = texts["lang_name"]
            break

    # NEW: Simplified prompt to only ask for Name and Description
    prompt = f"""
    Create a concise and exciting travel guide for "{city_name}".
    You MUST respond in this language: {lang_name} (language code: {lang_code}).
    
    You MUST provide two pieces of information for each item, separated by a pipe |.
    STRICTLY follow the format: 1. [Name] | [Description]
    Do not add any other text before or after the numbered lists.

    Example (if user requested 'Paris' and language 'en'):
    1. Eiffel Tower | A famous 19th-century iron lattice tower. It is one of the most recognizable structures in the world. Visitors can ride an elevator to the top for breathtaking views of the city.
    
    Here are the headings to use (translated to {lang_name}). Please provide 5 items for each category:
    ### Top 5 Tourist Attractions
    1. [Name] | [A brief, 3-sentence description]
    2. [Name] | [A brief, 3-sentence description]
    3. [Name] | [A brief, 3-sentence description]
    4. [Name] | [A brief, 3-sentence description]
    5. [Name] | [A brief, 3-sentence description]
    ### Top 5 Local Dishes to Try
    1. [Name] | [A brief, 3-sentence description]
    2. [Name] | [A brief, 3-sentence description]
    3. [Name] | [A brief, 3-sentence description]
    4. [Name] | [A brief, 3-sentence description]
    5. [Name] | [A brief, 3-sentence description]
    ### Top 5 Things to Avoid
    1. [Name] | [A brief, 3-sentence description]
    2. [Name] | [A brief, 3-sentence description]
    3. [Name] | [A brief, 3-sentence description]
    4. [Name] | [A brief, 3-sentence description]
    5. [Name] | [A brief, 3-sentence description]
    """
    try:
        response = groq_client.chat.completions.create(
            model="llama-3.1-8b-instant",
            messages=[
                {"role": "system", "content": "You are a helpful travel assistant."},
                {"role": "user", "content": prompt}
            ]
        )
        return response.choices[0].message.content
    except Exception as e:
        return text_dict["guide_error"].format(e=e)

# NEW: Simplified parser for the new prompt
def parse_guide_to_dict(guide_text):
    """Parses the raw text output from the AI into a structured dictionary."""
    guide_dict = {}
    sections = re.split(r'###\s*(.+)', guide_text)[1:]
    
    if not sections:
        print("Parser Error: No '###' sections found in AI response.")
        return {} 

    for i in range(0, len(sections), 2):
        if i + 1 < len(sections):
            title = sections[i].strip()
            content = sections[i+1].strip()
            items = []
            
            item_lines = re.findall(r"^\s*\d+\.\s*(.+)", content, re.MULTILINE)
            
            if not item_lines:
                 print(f"Parser Error: No numbered items found for section '{title}'.")
                 
            for item_line in item_lines:
                name, description = "", ""
                
                if '|' in item_line:
                    parts = item_line.split('|', 1) # Split into max 2 parts
                    name = parts[0].strip()
                    if len(parts) > 1:
                        description = parts[1].strip()
                else:
                    name = item_line.strip()
                    description = "..." # Add a placeholder if AI forgets
                
                if name:
                    items.append({"name": name, "description": description})
            
            if items:
                guide_dict[title] = items
    
    if not guide_dict:
         print(f"Parser Error: Final dictionary is empty. AI response was:\n{guide_text}")
         
    return guide_dict

def format_guide_for_download(guide_dict, city_name, lang_name):
    """Formats the guide dictionary into a clean string for .txt download."""
    download_text = f"Your Travel Guide for {city_name}\n"
    download_text += f"(Language: {lang_name})\n"
    download_text += "="*40 + "\n\n"
    
    for category, items in guide_dict.items():
        download_text += f"### {category}\n\n"
        for i, item in enumerate(items, 1):
            download_text += f"{i}. {item['name']}\n"
            download_text += f"   {item['description']}\n\n"
        download_text += "\n"
    
    return download_text

def generate_google_maps_link(item, city):
    """Generates a safe, encoded Google Maps link."""
    query = f"{item}, {city}"
    encoded_query = quote_plus(query)
    return f"https://www.google.com/maps/search/?api=1&query={encoded_query}"

# --- STREAMLIT UI ---

st.set_page_config(page_title="Trip Whisperer", page_icon="тЬИя╕П", layout="wide")

st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    html, body, [class*="st-"] { font-family: 'Poppins', sans-serif; }
    .stApp { background-color: #0E117; }
    .block-container { max-width: 800px; padding-top: 2rem; padding-bottom: 2rem; }
    h1, h2, h3, p, .stMarkdown, .stTextInput>label { color: #FFFFFF; }
    h1 { text-align: center; }
    .stTextInput>div>div>input { border-radius: 15px; border: 1px solid #30363F; background-color: #0E117; color: #FFFFFF; padding: 12px; }
    .stButton>button { width: 100%; border-radius: 15px; border: none; background-color: #007BFF; color: white; padding: 12px; transition: background-color 0.3s ease; }
    .stButton>button:hover { background-color: #0056b3; }
    .card { background-color: #161B22; border: 1px solid #30363F; border-radius: 15px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 25px; }
    .card h3 { color: #58A6FF; border-bottom: 1px solid #30363F; padding-bottom: 10px; }
    .card a { color: #58A6FF; text-decoration: none; }
    .card a:hover { text-decoration: underline; color: #80BFFF; }
    #MainMenu, footer, header { visibility: hidden; }
</style>
""", unsafe_allow_html=True)

# --- Main Application Flow ---

language_options = {texts["lang_name"]: code for code, texts in translations.items()}
selected_language_name = st.selectbox(
    label=translations["en"]["lang_select"], # Label is always in English
    options=language_options.keys(),
    index=0 
)
selected_lang_code = language_options[selected_language_name]

ui_texts = translations[selected_lang_code]

st.title(ui_texts["title"])

city_input = st.text_input(
    "Enter a city name:", 
    label_visibility="collapsed", 
    placeholder=ui_texts["placeholder"]
)

if st.button(ui_texts["button"]) and city_input:
    
    cleaned_city_name = city_input.strip().strip(string.punctuation)
    
    with st.spinner(ui_texts["spinner"].format(city_name=cleaned_city_name)):
        
        st.markdown("<div class='card'>", unsafe_allow_html=True)
        weather_info = get_weather_info(cleaned_city_name, WEATHER_API_KEY)
        st.markdown(f"**{ui_texts['weather_header'].format(city_name=cleaned_city_name.title())}**")
        st.write(weather_info)
        
        flight_link = generate_flight_search_link(cleaned_city_name)
        st.markdown(f"<a href='{flight_link}' target='_blank' style='display:inline-block; margin-top:10px; padding:8px 16px; background-color:#2563EB; color:white; border-radius:10px; text-decoration:none;'>{ui_texts['flights_button'].format(city_name=cleaned_city_name.title())}</a>", unsafe_allow_html=True)
        st.markdown("</div>", unsafe_allow_html=True)

        st.markdown("<div class='card'>", unsafe_allow_html=True) 
        st.subheader(ui_texts["summary_header"].format(city_name=cleaned_city_name.title()))
        summary = get_city_summary(cleaned_city_name, selected_lang_code, ui_texts)
        st.write(summary)
        st.markdown("</div>", unsafe_allow_html=True)

        guide_text = generate_travel_guide(cleaned_city_name, selected_lang_code, ui_texts)
        
        if "Could not generate guide" in guide_text:
            st.error(guide_text)
        else:
            parsed_guide = parse_guide_to_dict(guide_text)
            
            if not parsed_guide:
                st.error("The AI returned an invalid format. Please try again.")
            else:
                st.markdown("<div class='card'>", unsafe_allow_html=True)
                
                for category, items in parsed_guide.items():
                    st.subheader(category)
                    for item in items:
                        
                        col1, col2 = st.columns([1, 2]) 
                        
                        with col1:
                            # NEW: Get image from Wikipedia
                            image_url = get_image_url(item["name"], selected_lang_code)
                            st.image(image_url, caption=f"{item['name']}", use_container_width=True)
                        
                        with col2:
                            map_link = generate_google_maps_link(item["name"], cleaned_city_name)
                            st.markdown(f"#### [{item['name']}]({map_link})")
                            st.write(item["description"])
                            
                        st.divider() 
                        
                st.markdown("</div>", unsafe_allow_html=True)
                
                st.success(ui_texts["success"])
                
                st.markdown("---")
                
                download_text = format_guide_for_download(parsed_guide, cleaned_city_name, selected_language_name)
                
                st.download_button(
                    label=ui_texts["download_button"],
                    data=download_text,
                    file_name=f"{cleaned_city_name}_guide.txt",
                    mime="text/plain",
                    use_container_width=True
                )

# --- Footer ---
st.markdown("---")
st.markdown(f"<div style='text-align: center; color: #888; font-size: 0.9rem;'>{ui_texts['footer']}</div>", unsafe_allow_html=True)


